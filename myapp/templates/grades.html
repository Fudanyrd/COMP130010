{% extends "base.html" %} {% block content %}
<p>This is a list of all grades from course {{ course }}</p>
<ul>
  {% for grade in grades %}
  <li>
    {{ grade }} <a href="{% url 'myapp:regrade' grade.id %}">Regrade this</a>
  </li>
  {% if grade.passed %}
  <p style="color: green">{{ grade.bar_chart }}</p>
  {% else %}
  <p style="color: red">{{ grade.bar_chart }}</p>
  {% endif %} {% endfor %} {% for student in ungraded %}
  <li>
    {{ student }}: Ungraded {% if student.gender == 'M' %}
    <a href="{% url 'myapp:givegrade' course.id student.id %}">Grade Him</a>
    {% else %}
    <a href="{% url 'myapp:givegrade' course.id student.id %}">Grade Her</a>
    {% endif %}
  </li>
  {% empty %}
  <p>You have given grades to all students.</p>
  {% endfor %}
</ul>

<p>
  You may want to view grades as a table.
  <a href="{% url 'myapp:gradetb' course.id %}">link</a>
</p>
<p>
  For convenience, you may use this
  <a href="{% url 'myapp:gradeall' course.id %}">link</a>
  to grade all students in one form.
</p>

<canvas class="barchart" width="600" height="480"></canvas>
<script>
  let chart = document.querySelector('.barchart');
  let ctx = chart.getContext("2d");

  // get distribution of grades.
  getDistribution = (gds) => {
    let res = [0, 0, 0, 0, 0];
    for (grade of gds) {
      if (grade >= 80) {
        if (grade >= 90) { res[4] += 1; }
        else { res[3] += 1; }
      } else {
        if (grade >= 70) { res[2] += 1; }
        else {
          if (grade >= 60) { res[1] += 1; }
          else {res[0] += 1; }
        }
      }
    }
    return res;
  }
  // given an array, draw the bar chart.
  draw = (arr, width, gap,maxWidth, maxHeight) => {
    // width is the attribute of each bar.
    // gap is the distance between bars.
    let max = 0;
    ctx.fillStyle = '#f3f3f3';
    ctx.fillRect(0, 0, maxWidth, maxHeight);
    
    for (let i = 0; i < arr.length; ++i) {
      if (arr[i] > max) {
        max = arr[i];
      }
    }
    console.log(max);
    let initialX = gap;
    for (let i = 0; i < arr.length; ++i) {
      let count = arr[i];
      ctx.fillStyle = i===0 ? 'rgb(255,0,0)' : 'rgb(0, 0, 255)';
      let height = Math.floor(0.8 * maxHeight * (count / max));
      ctx.fillRect(initialX, maxHeight-height, width, height);
      ctx.strokeStyle = "green";
      ctx.lineWidth = 1;
      ctx.font = "36px arial";
      ctx.strokeText(`${count}`, initialX + 16, maxHeight-height-20);
      initialX += (width + gap);
    }
    initialX = gap;
    strs = ['failure', '[60,70)', '[70,80)', '[80,90)', '90+'];
    for (let i = 0; i < 5; ++i) {
      ctx.strokeStyle = "black";
      ctx.lineWidth = 1;
      ctx.font = "24px Tahoma";
      ctx.strokeText(`${strs[i]}`, initialX, 30);
      initialX += (width + gap);
    }
  }

  // plot a barchart of grades to show distribution.
  let gradearr = [];
  // these lines will be replaced.. a little contradictory to instinct though...
  {% for grade in grades %}
    gradearr.push({{ grade.value }});
  {% endfor %}

  let distribution = getDistribution(gradearr);
  draw(distribution, 60, 30, chart.width, chart.height);
</script>
{% endblock content %}
